#!/bin/bash
create_user() {
  while true; do
    read -r -p "Do you wish to create user zrr? [y/n] " yn
    case $yn in
      [Yy]* ) break;;
      [Nn]* ) exit;;
      * ) echo "Please input y(es) or n(o).";;
    esac
  done

  echo "creating user zrr..."
  useradd -r -g root zrr
  ln -s /root /home/zrr
  sed -i 's#zrr:x:[0-9]*:0::/home/zrr:/bin/sh#zrr:x:0:0::/home/zrr:/bin/zsh#g' /etc/passwd
  echo "zrr:0000" | chpasswd

  echo "Please login as zrr and run this script again:"
  echo "  su zrr"
  echo "  yadm bootstrap"
}

remove_unused_files() {
  if [[ ! -f "${YADM_HOOK_REPO}/info/sparse-checkout" ]]; then
    echo "Removing unused files..."
    yadm gitconfig core.sparseCheckout true
    cat << EOF > "${YADM_HOOK_REPO}/info/sparse-checkout"
# Generated by $0
/*
!README.md
!LICENSE
!.pre-commit-config.yaml
!.gitignore
EOF
    yadm checkout --quiet
  fi
}

remove_unused_files

if [[ ! -f /.dockerenv ]] && [[ $USER == "root" ]]; then
  create_user
fi

yadm alt
