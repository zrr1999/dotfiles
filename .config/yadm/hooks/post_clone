create_user() {
  echo "creating user zrr..."
  useradd -r -g root zrr
  ln -s /root /home/zrr
  sed -i 's#zrr:x:999:0::/home/zrr:/bin/sh#zrr:x:0:0::/home/zrr:/bin/zsh#g' /etc/passwd
  echo "zrr:0000" | chpasswd

  echo "Please login as zrr and run this script again:"
  echo "  su - zrr"
  echo "  yadm bootstrap"
}

remove_unused_files() {
  if [[ ! -f "${YADM_HOOK_REPO}/info/sparse-checkout" ]]; then
    echo "Removing unused files..."
    yadm gitconfig core.sparseCheckout true
    cat << EOF > "${YADM_HOOK_REPO}/info/sparse-checkout"
# Generated by $0
/*
!README.md
!LICENSE
!.pre-commit-config.yaml
!.gitignore
!tools/
EOF
    yadm checkout --quiet
  fi
}

init_password() {
  bw config server password.bone6.top
  bw login 2742392377@qq.com $1

  # TDDO: use $1 in yadm decrypt
  yadm decrypt
}

remove_unused_files
read -s -p "Please input your Bitwarden and YADM password: " password
init_password $password
if [[ $(id -u zrr) -eq 0 && "$OSTYPE" != "darwin"* ]]; then
  create_user
fi
