#!/usr/bin/env bash

# Setup sudo fallback for environments without sudo
setup_sudo() {
  if ! command -v sudo >/dev/null 2>&1; then
    if [[ "$USER" == "root" ]]; then
      # Create a fake sudo function for root user
      sudo() { "$@"; }
      export -f sudo
    else
      echo "error: sudo not available and not running as root" >&2
      exit 1
    fi
  fi
}

# Install system-agnostic applications using independent installation methods
install_independent_apps() {
  echo "Installing system-agnostic applications..."
  
  # Install bun JavaScript runtime
  if ! command -v bun >/dev/null 2>&1; then
    echo "Installing bun..."
    curl -fsSL https://bun.sh/install | sed 's/\.zshrc/\.config/zsh/dotconfig/.bunconfig/g' | bash
  else
    echo "bun is already installed"
  fi
  
  # Install uv Python package manager if not available
  if ! command -v uv >/dev/null 2>&1; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
  else
    echo "uv is already installed"
  fi
  
  # Setup git-lfs if it was installed
  if command -v git-lfs >/dev/null 2>&1; then
    git lfs install
  fi
}

# Install zsh with different methods for different systems
install_zsh() {
  if command -v zsh >/dev/null 2>&1; then
    echo "zsh is already installed"
    return
  fi
  
  echo "Installing zsh..."
  if [[ -f /etc/arch-release ]]; then
    sudo pacman -S --noconfirm --needed zsh
  elif [[ "$OSTYPE" == "darwin"* ]]; then
    brew install zsh
  elif command -v apt >/dev/null 2>&1; then
    sudo apt update && sudo apt install -y zsh
  else
    echo "error: unsupported system, please install zsh manually" >&2
  fi
}

# Get package name, handling exceptions for different package managers
get_package_name() {
  local package=$1
  local manager=$2
  
  # Handle package name exceptions
  case "${package}:${manager}" in
    "gh:pacman")
      echo "github-cli"
      ;;
    "gpg:pacman"|"gpg:paru"|"gpg:brew")
      echo "gnupg"
      ;;
    *)
      echo "$package"
      ;;
  esac
}

# Install packages with given package manager
install_packages() {
  local manager=$1
  local cmd=$2
  shift 2
  local package_list=("$@")
  
  if [[ ${#package_list[@]} -eq 0 ]]; then
    return
  fi
  
  local packages=()
  for package in "${package_list[@]}"; do
    packages+=("$(get_package_name "$package" "$manager")")
  done
  
  echo "Installing with $manager: ${packages[*]}"
  $cmd "${packages[@]}"
}

# Essential packages - available in all package managers (zsh handled separately)
ESSENTIAL_PACKAGES=(lua starship fastfetch lsd dust)

# Full packages - may not be available in apt, will use x-cmd fallback
FULL_PACKAGES=(git yadm gpg python gh bat sd ripgrep fd bottom procs duf httpie nexttrace ast-grep 
              git-delta gitui zellij difftastic helix pueue fzf progress atuin 
              hyperfine bitwarden-cli micromamba uv git-lfs)

# Install based on system and user type
install_programs() {
  setup_sudo
  
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS - always non-root user, install everything
    if [[ "$USER" == "root" ]]; then
      echo "error: macOS should not run as root user" >&2
      exit 1
    fi
    
    echo "=== macOS: Installing all programs with brew ==="
    install_zsh
    install_packages "brew" "brew install" "${ESSENTIAL_PACKAGES[@]}" "${FULL_PACKAGES[@]}"
    install_macos_specific
    
  elif [[ -f /etc/arch-release ]]; then
    # Arch Linux - check user type
    install_zsh
    if [[ "$USER" == "root" ]]; then
      echo "=== Arch Linux (root): Installing essential programs with pacman ==="
      install_packages "pacman" "pacman -S --noconfirm --needed" "${ESSENTIAL_PACKAGES[@]}"
    else
      echo "=== Arch Linux (user): Installing all programs with paru ==="
      install_paru_if_needed
      install_packages "paru" "paru -S --noconfirm --needed" "${ESSENTIAL_PACKAGES[@]}" "${FULL_PACKAGES[@]}"
    fi
    
  elif command -v apt >/dev/null 2>&1; then
    # Ubuntu - install zsh with apt, rest with x-cmd
    echo "=== Ubuntu: Installing zsh with apt, others with x-cmd ==="
    install_zsh
    
    # TODO: merge to install_programs
    install_with_xcmd
    install_packages "xcmd" "x env use" "${ESSENTIAL_PACKAGES[@]}"
    
  else
    echo "error: unsupported system" >&2
    exit 1
  fi
  
  # Install system-agnostic applications
  install_independent_apps
}

# Install paru if needed (for Arch Linux non-root users)
install_paru_if_needed() {
  if ! command -v paru >/dev/null 2>&1; then
    echo "Installing paru..."
    sudo pacman -S --noconfirm --needed base-devel rustup
    rustup default stable
    git clone https://aur.archlinux.org/paru.git
    cd paru && makepkg -si && cd ..
    rm -rf paru
  fi
  # Install Arch-specific packages
  paru -S --noconfirm --needed unrar
}

# Install packages with x-cmd
install_with_xcmd() {
  [[ -f $HOME/.x-cmd.root/X ]] || eval "$(curl https://get.x-cmd.com)"
  x env use gh
}

# macOS specific installations
install_macos_specific() {
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

  # Install additional tools
  brew install bundler-completion squirrel-app pinentry-mac
  
  # Install cask applications
  brew install --cask linearmouse he3-app/he3/he3
}

install_by_uv() {
  uv tool install pre-commit
  uv tool install auto-config
  uv tool install auto-token
  # install nvitop if nvidia-smi exists
  if command -v nvidia-smi >/dev/null 2>&1; then
    uv tool install nvitop
  fi
}

config_zsh() {
  if ! command -v zi >/dev/null 2>&1; then
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/z-shell/zi-src/main/lib/sh/install.sh)" -- -i skip
    zsh -cl -- '(source $HOME/.config/zsh/.zi.zsh && @zi-scheduler burst) || true'
  fi
  # setup .zprofile
  if [[ ! -f $HOME/.zprofile ]]; then
    touch $HOME/.zprofile
    echo "emulate sh -c 'source /etc/profile'" | tee -a $HOME/.zprofile
  fi
}

if [[ -n "$GITHUB_ACTIONS" ]]; then
  echo "::group::installing packages"
fi
install_programs
install_by_uv
if [[ -n "$GITHUB_ACTIONS" ]]; then
  echo "::endgroup::"
fi

if [[ -n "$GITHUB_ACTIONS" ]]; then
  echo "::group::configuring zsh"
fi
auto-config generate-config
auto-token init
config_zsh
if [[ -n "$GITHUB_ACTIONS" ]]; then
  echo "::endgroup::"
fi
